<script setup lang="ts">
import {scalar, vec2} from 'linearly'
import {computed, ref} from 'vue'

import {DragEvent, useElementDrag} from '@/use/useElementDrag'

const props = defineProps<{
	modelValue: number
	duration: number
	amplitude: number
}>()

const emit = defineEmits<{
	'update:modelValue': [value: number]
}>()

const $slider = ref<HTMLElement | null>(null)

const {dragging} = useElementDrag($slider, {
	onPointerdown,
	onDrag,
})

let knobOffset = 0

function onPointerdown(e: DragEvent) {
	const isKnobPressed = e.target.classList.contains('knob')

	if (isKnobPressed) {
		const {left, right} = e.target.getBoundingClientRect()
		const center = (left + right) / 2
		knobOffset = center - e.client[0]
	} else {
		knobOffset = 0
	}

	onDrag(e)
}

function onDrag(e: DragEvent) {
	const {left, right} = $slider.value!.getBoundingClientRect()
	const {
		client: [clientX],
	} = e

	const newValue = scalar.fit(
		clientX + knobOffset,
		left,
		right,
		0,
		props.duration
	)

	emit('update:modelValue', newValue)
}

const f = (t: number): vec2 => [
	t * 100,
	Math.sin(t * Math.PI * 2 * 5) * 3 + 0.5,
]

const d =
	'M 0,0.5 C 0.8333333333333334,1.2853981504781413 1.6666666666667584,2.065872749623422 2.5,2.6213203435596424 C 3.3333333333332416,3.1765934658924015 4.166666666666388,3.4998766299461974 5,3.5 C 5.833333333333612,3.4998766299461974 6.66666666666713,3.1765934658924015 7.500000000000001,2.621320343559642 C 8.333333333332872,2.065872749624162 9.16666666666713,1.285398150477216 10,0.5000000000000003 C 10.83333333333287,-0.2853981504772154 11.66666666666713,-1.0658727496241625 12.5,-1.6213203435596424 C 13.333333333334352,-2.1765934658931423 14.16666666666565,-2.4998766299461974 15.000000000000002,-2.5 C 15.833333333334354,-2.4998766299461974 16.666666666668608,-2.176593465892032 17.5,-1.6213203435596428 C 18.333333333334352,-1.0658727496212024 19.166666666665648,-0.28539815047726264 20,0.4999999999999993 C 20.833333333334352,1.2853981504794816 21.666666666665648,2.065872749624162 22.5,2.621320343559642 C 23.333333333334352,3.1765934658949915 24.166666666665648,3.4998766299461974 25,3.5 C 25.833333333334352,3.4998766299461974 26.66666666666565,3.1765934658931414 27.500000000000004,2.6213203435596415 C 28.333333333334355,2.065872749622681 29.16666666666565,1.2853981504794327 30.000000000000004,0.4999999999999958 C 30.833333333334355,-0.2853981504794395 31.66666666666861,-1.0658727496193534 32.5,-1.6213203435596437 C 33.333333333337315,-2.1765934658931436 34.16666666666861,-2.4998766299461974 35,-2.5 C 35.83333333333731,-2.4998766299461974 36.66666666666861,-2.176593465893144 37.5,-1.6213203435596455 C 38.33333333333139,-1.065872749619354 39.16666666666861,-0.2853981504750438 40,0.49999999999999856 C 40.833333333337315,1.2853981504794354 41.66666666666269,2.0658727496223164 42.50000000000001,2.6213203435596473 C 43.333333333331396,3.176593465889815 44.16666666666861,3.4998766299461974 45,3.5 C 45.833333333337315,3.4998766299461974 46.66666666666861,3.1765934658901847 47.5,2.6213203435596455 C 48.33333333333731,2.065872749619355 49.16666666666861,1.2853981504794372 50,0.5000000000000019 C 50.83333333333139,-0.28539815047504047 51.66666666667453,-1.0658727496260127 52.5,-1.6213203435596428 C 53.33333333333139,-2.176593465890182 54.16666666666862,-2.4998766299461974 55.00000000000001,-2.5 C 55.83333333332548,-2.4998766299461974 56.66666666666862,-2.1765934658901775 57.50000000000001,-1.6213203435596384 C 58.333333333331396,-1.0658727496256382 59.16666666667454,-0.2853981504749876 60.00000000000001,0.5000000000000084 C 60.833333333331396,1.2853981504750012 61.66666666666861,2.065872749625645 62.5,2.621320343559643 C 63.33333333333139,3.176593465890182 64.16666666667453,3.4998766299461974 65,3.5 C 65.83333333333731,3.4998766299461974 66.66666666667453,3.176593465890555 67.5,2.621320343559646 C 68.33333333333731,2.0658727496256457 69.16666666667453,1.2853981504661167 70,0.5000000000000026 C 70.83333333333731,-0.2853981504749935 71.6666666666627,-1.0658727496256497 72.50000000000001,-1.62132034355965 C 73.33333333332548,-2.176593465890187 74.16666666667453,-2.4998766299461974 75,-2.5 C 75.83333333332547,-2.4998766299461974 76.66666666667453,-2.1765934658901855 77.5,-1.6213203435596464 C 78.33333333333731,-1.0658727496256462 79.16666666667453,-0.285398150474999 80,0.49999999999999706 C 80.83333333333731,1.2853981504750394 81.66666666667453,2.0658727496315636 82.5,2.6213203435596424 C 83.33333333333731,3.1765934658901815 84.1666666666627,3.4998766299461974 85.00000000000001,3.5 C 85.83333333332548,3.4998766299461974 86.66666666667453,3.1765934658898134 87.5,2.621320343559647 C 88.33333333332547,2.0658727496256466 89.16666666667453,1.2853981504749994 90,0.5000000000000033 C 90.83333333333731,-0.285398150475039 91.66666666667453,-1.0658727496256417 92.5,-1.621320343559642 C 93.33333333333731,-2.176593465890181 94.16666666667453,-2.4998766299461974 95,-2.5 C 95.83333333333731,-2.4998766299461974 96.6666666666627,-2.1765934658901784 97.50000000000001,-1.6213203435596393 C 98.33333333332548,-1.0658727496256415 99.16666666667453,-0.2853981504749964 100,0.49999999999999634' //Path.toD(Path.formula(f, Iter.range(0, 1, 0.025)))

const trackTransform = computed(() => {
	return `scale(1 ${Math.max(props.amplitude, 0.0001)})`
})

const knobStyle = computed(() => {
	const topOffset =
		f(props.modelValue / props.duration)[1] * 1.5 * props.amplitude

	return {
		left: `${(props.modelValue / props.duration) * 100}%`,
		top: `calc(50% + ${topOffset}rem)`,
	}
})
</script>

<template>
	<div class="Slider" :class="{dragging}" ref="$slider">
		<svg
			class="track"
			xmlns="http://www.w3.org/2000/svg"
			viewBox="0 0 100 1"
			preserveAspectRatio="none"
		>
			<path class="stroke" :d="d" :transform="trackTransform" />
		</svg>
		<div class="knob-wrapper" :style="knobStyle">
			<button class="knob fa fa-regular fa-circle" v-hover />
		</div>
	</div>
</template>

<style scoped lang="stylus">
.Slider
	position relative
	width 100%
	display flex
	align-items center

.track
	width 100%
	height 2rem
	overflow visible

.stroke
	stroke var(--black)
	stroke-width 5
	fill none
	vector-effect non-scaling-stroke
	shape-rendering crispEdges

.knob-wrapper
	position absolute
	top 50%

.knob
	position absolute
	display block
	top 0
	left 0
	font-size calc(0.5 * var(--header-height))
	text-align center
	line-height calc(0.5 * var(--header-height))
	width calc(0.5 * var(--header-height))
	height calc(0.5 * var(--header-height))
	background var(--white)
	border-radius 50%
	transition transform 0.1s steps(3)
	cursor ew-resize
	transform translate3d(-50%, -50%, 0)
	will-change transform


	&.hover
		transform translate3d(-50%, -50%, 0) scale(1.2)

	.dragging &
		transform translate3d(-50%, -50%, 0) scale(1.4)
</style>
